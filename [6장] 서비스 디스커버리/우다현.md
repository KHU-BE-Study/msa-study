# 6장. 서비스 디스커버리

- 서비스 디스커버리란?
    
    MSA로 구성되어 있는 서비스들은 각자 다른 IP와 Port를 가지고 있는데, 서로 다른 서비스들의 ip와 port 정보에 대해서 저장하고 관리할 필요가 있다.
    즉, 서비스 디스커버리는 **동적으로 변화하는 마이크로서비스 인스턴스들의 위치(ip/port)를 자동으로 등록하고 검색** 할 수 있게 도와주는 시스템이다.
    
![문제점](https://github.com/user-attachments/assets/c308dba7-4718-4272-9516-7081f63112f1)
이 그림은 동적으로 IP/포트가 할당되는 서비스 인스턴스들에 대해 클라이언트가 어떤 인스턴스에 요청할지 결정하기 어렵다는 문제를 보여준다. 따라서 이러한 동적인 환경에서는 서비스 디스커버리가 필요하다. 이를 통해 클라이언트는 인스턴스 목록을 알 수 있고, 그중 하나를 선택하거나 로드밸런싱을 적용해 요청을 보낼 수 있다.


<br>

- 서비스 디스커버리의 중요성!
    - **수평 확장**
        
        : 서비스 소비자에게 서비스의 물리적 위치는 추상화되어 있기에, 새 서비스 인스턴스는 가용 서비스 풀에 추가되거나 제거될 수 있음
        
    - **회복성**
        
        : 마이크로서비스 인스턴스가 비정상이거나 가용하지 못한 상태가 되면 대부분의 서비스 디스커버리 엔진은 그 인스턴스를 가용 서비스 목록에서 제거, 이때 서비스 디스커버리 엔진은 사용 불가 서버 우회해서 라우팅 함
        
<br>

## 6.1 서비스 위치 확인

서비스 위치 확인은 DNS와 네트워크 로드 밸러서의 조합으로 해결

  ### 로드밸런서

  로드밸런싱 : 둘 혹은 셋 이상의 중앙처리장치 혹은 저장장치와 같은 컴퓨터 자원들에게 작업(Work), 즉, 부하(Load)를 나누는 것을 의미
![image](https://github.com/user-attachments/assets/55ae3622-2032-49a0-b5ba-2828ac027525)

  로드밸런서 : 클라이언트와 서버 pool 사이에 위치해서 서버의 부하를 분산시키는 하드웨어나 소프트웨어를 의미
   - 중앙 집중식 네트워크 인프라스트럭처로 처리할 수 있는 대부분의 애플리케이션 크기와 규모를 가진 기업 환경에서 잘 작동
   - SSL 종료를 처리하고 서비스 포트 보안을 관리하는 데 여전히 중요한 역할
  - 뒷단의 모든 서버에 대한 들어오고 나가는 포트의 접근을 제한할 수 있음 (최소 네트워크 접근 개념)

<br>

*전통적인 서비스 위치 확인 모델은 클라우드 기반의 마이크로 서비스 애플리케이션에서는 잘 동작하지 않는다.

- 고가용성 로드 밸런서를 만들 수 있더라도 전체 인프라스트럭처에서 보면 단일 장애 지점
- 서비스를 하나의 로드 밸런서 클러스터에 집중시키면 여러 서버에 부하를 분산하는 인프라스트럭처의 수평 확장 능력이 제한된다.
- 전통적인 로드 밸런서 대부분은 고정적으로 관리된다.
- 로드 밸런서가 프록시 역할을 하므로 서비스 소비자 요청은 물리적 서비스에 매핑되어야한다.

⇒ 대규모 트랜잭션과 이중화를 처리해야하는 클라우드에서는 중앙 집중식 네트워크 인프라스트럭처는 효율적으로 확장되지 않고 비용 효율도 낮은 문제!!

<br>

## 6.2 클라우드에서 서비스 디스커버리

- 클라우드 기반 마이크로서비스 환경에서 해결책 ⇒ 고가용성, P2P, 부하 분산, 회복성, 결함 내성 특징을 가진 서비스 디스커버리 메커니즘을 사용하는 것

### 서비스 디스커버리 아키텍처

서비스 디스커버리를 알아보기전 4가지 개념에 대해 먼저 알아보자

1. **서비스 등록** : 서비스가 디스커버리 에이전트에 등록
2. **클라이언트의 서비스 주소 검색** : 서비스 클라이언트가 서비스 정보를 검색
3. **정보 공유** : 노드 간 서비스 정보를 공유하는 방법
4. **상태 모니터링** : 서비스가 서비스 디스커버리에 상태를 전달하는 방법

<br>

구현에는 두 가지 방법이 있다.

1. **클라이언트 사이드 디스커버리 패턴**
    
    : client 가 Service registry 에 물어서 서비스 위치를 찾은 후에 로드밸런싱 알고리즘을 통해 호출을 하는 방식
    
    - 대표적인 discovery library 는 Netflix 오픈소스인 Eureka,Ribbon 등
    
    장) 비교적 간단, 호출하려는 서비스를 알고 있기 때문에 서비스에 맞는 로드밸런싱 방식을 각자 구현 가능
    
    단) 각 서비스마다 서비스 레지스토리 구현해야하는 종속성 생김

    ![image1 cbab2cf 17d4bb3eb42a30bde52caa127c713cc3](https://github.com/user-attachments/assets/994368d0-c612-4c05-af42-e58a8cc67ccc)
 
    <br>

2. **서버 사이드 디스커버리 패턴**
    
    : **Server-Side discovery 방식**은 client 가 플랫폼 라우터로 서비스를 호출하여 달라고 요청을 보내는 방식
    
    - 대표적 플랫폼 라우터 - AWS ELB, 구글 로드밸런서
    
    장) 디스커버리 로직 클라이언트에서 분리
    
    단) 로드밸런서는 배포 환경에 구축되어야함, 서비스 디스커버리가 죽으면 전체 시스템이 동작하지 않음
    
    ![image2 cbab2cf 2f5816704e08a5508ed8c6c6b011066b](https://github.com/user-attachments/assets/adde6ad1-df6e-4042-a27c-dd09ea52b6e6)


<br>

| 구분 | 클라이언트 사이드 디스커버리 | 서버 사이드 디스커버리 |
|------|-----------------------------|-------------------------|
| 방식 | 클라이언트가 직접 서비스 위치 조회 및 호출 | 클라이언트는 로드밸런서에 요청, 로드밸런서가 서비스 위치 결정 |
| 장점 | 단순하고 유연한 로드밸런싱 | 디스커버리 로직이 클라이언트에 없음 |
| 단점 | 클라이언트에 라이브러리 의존성 | 중앙 로드밸런서 실패 시 전체 장애 가능 |
| 예시 | Netflix Eureka + Ribbon | AWS ELB, Kubernetes Service |
